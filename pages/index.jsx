import React, { useState, useEffect } from "react";
import ContainerContent from "../components/ContainerContent";
import SnackAlert from "../components/SnackAlert";
import MuiDataTable from "../components/MuiDataTable";
import * as utils from '../helpers/utils'

export default function AssetVulnerability() {

    const [data, setData] = useState([]);
    const [openAlert, setOpenAlert] = useState(false);

    const handleCloseAlert = (event, reason) => {
        if (reason === "clickaway") {
            return;
        }
        setOpenAlert(false);
    };

    useEffect(() => {
        async function fetchData() {

            let page = 1 //variavel para percorrer a paginação da view
            var data = []
            do {
                const response = await fetch(`${process.env.NEXT_PUBLIC_DASH_URL}/api/vulnerability_report/?page=${page}`);
                var responseData = await response.json()
                for (let item of responseData.results) {
                    data.push(item)
                }
                page += 1
            } while (responseData.next != null) // faz a função acima até que a view seja percorrida até a ultima pagina

            setData(data);
        }
        fetchData();
    }, []);

    // MUI Data Table ........
    const columns = [
        {
            name: "id",
            label: "ID",
            options: {},
            flex: 1,
        },
        {
            name: "hostname",
            label: "HOSTNAME",
            options: {},
            flex: 1,
        },
        {
            name: "ip_addres",
            label: "IP ADDRES",
            options: {},
            flex: 1,
        },
        {
            name: "title",
            label: "TITLE",
            options: {},
            flex: 1,
        },
        {
            name: "severity",
            label: "SEVERITY",
            options: {},
            flex: 1,
        },
        {
            name: "cvss",
            label: "CVSS",
            options: {},
            flex: 1,
        },
        {
            name: "publication_date",
            label: "PUBLICATIONS DATE",
            options: {},
            flex: 1,
        },
        {
            name: "status",
            label: "STATUS",
            options: {},
            flex: 1,
        },
    ];

    const rows = data.map((row, idx) => {
        return {
            id: row.id,
            hostname: row.hostname,
            ip_addres: row.ip_addres,
            title: row.title,
            severity: utils.render_severity(row.severity),
            cvss: row.cvss,
            publication_date: utils.render_date(row.publication_date),
            status: utils.render_status(row.status)
        };
    });

    return (
        <>
            <ContainerContent title="Gerenciador de Vulnerabilidades">
                <MuiDataTable title={""} data={rows} columns={columns}></MuiDataTable>
                <SnackAlert message={"Não há dados para exibir."} open={openAlert} onClose={handleCloseAlert} />
            </ContainerContent>
        </>
    );
}
